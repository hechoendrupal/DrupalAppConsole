sudo: false

language: php

php:
  #- 5.6
  #- 7.0
  - 7.1
  #- 7.2
  #- 7.3
  #- 7.4snapshot

matrix:
#  include:
#    - php: 5.5.9
#      dist: trusty
  fast_finish: true
  allow_failures:
    - php: 7.4snapshot

env:
  global:
    - PROJECT_DIR=/home/project

    # Drupal paths.
    - DRUPAL_STAGING_DIR="$HOME/drupal_staging"
    - DRUPAL_PATH="$HOME/drupal8"
    - PATH="$PATH:$DRUPAL_PATH/vendor/bin:$HOME/.composer/vendor/bin"

    # Testing environment variables.
    - SIMPLETEST_DB=mysql://root:@127.0.0.1/drupal_travis_db
    - SIMPLETEST_BASE_URL=http://127.0.0.1:8080

    # Suppress deprecation handling.
    #- SYMFONY_DEPRECATIONS_HELPER=disabled

before_install:
  - phpenv config-rm xdebug.ini || true
  # This fixes a fail when install Drupal.
  - echo 'sendmail_path = /bin/true' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

  - git clone --depth=50 http://git.drupal.org/project/drupal.git $DRUPAL_PATH
  - cd $DRUPAL_PATH
  - git checkout 8.8.x
  - composer install --no-progress --no-suggest
  - composer require "drupal/console:dev-master" --no-progress --no-suggest

  # Replace vendor/console with cloned one.
  - ls $DRUPAL_PATH/vendor/drupal
  - ls $DRUPAL_PATH/vendor/drupal/console
  - rm -rf $DRUPAL_PATH/vendor/drupal/console
  - mkdir -p $DRUPAL_PATH/vendor/drupal/console
  - cp -r $HOME/build/mondrake/drupal-console $DRUPAL_PATH/vendor/drupal/console
  - ls $DRUPAL_PATH/vendor/drupal
  - ls $DRUPAL_PATH/vendor/drupal/console

  #  - composer install --no-dev
#  - curl -LSs https://box-project.github.io/box2/installer.php | php
#  - composer global require drupal/coder:~8.1

script:
  - if [ -n "${TRAVIS_BUILD_DIR+1}" ]; then PROJECT_DIR=$TRAVIS_BUILD_DIR; fi
#  - phpunit
#  - php box.phar build
#  - php drupal.phar init
#  - php drupal.phar check
#  - php drupal.phar site:new drupal8.dev --latest --no-interaction
#  - cd drupal8.dev
#  - php ../drupal.phar site:install standard --langcode=en --db-type=sqlite --db-file=sites/default/files/.ht.sqlite --site-name="Drupal 8 Site Install" --site-mail=admin@example.com --account-name=admin --account-mail=admin@example.com --account-pass=admin --no-interaction
  - drupal site:install standard --langcode=en --db-type=sqlite --db-file=sites/default/files/.ht.sqlite --site-name="Drupal 8 Site Install" --site-mail=admin@example.com --account-name=admin --account-mail=admin@example.com --account-pass=admin --no-interaction
#  - php ../drupal.phar chain --file=$PROJECT_DIR/config/dist/chain/sample.yml
#  - ~/.composer/vendor/bin/phpcs --warning-severity=0 --standard=~/.composer/vendor/drupal/coder/coder_sniffer/Drupal/ruleset.xml $PROJECT_DIR/drupal8.dev/modules/custom/example

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/637685414a0d0ef9d4c6
    on_success: change
    on_failure: always
